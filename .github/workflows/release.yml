name: release

on:
  push:
    tags:
      - "v*"

jobs:
  build_release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install build tools
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y zip dpkg-dev

      - name: Read version from manifest.json
        id: ver
        shell: bash
        run: |
          set -euo pipefail
          VERSION="$(python -c 'import json;print(json.load(open("portable_data/config/manifest.json"))["version"])')"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Build portable zip
        shell: bash
        run: |
          set -euo pipefail
          ZIP="modultool_portable_${{ steps.ver.outputs.version }}.zip"
          # zip mit Root-Ordner modultool_portable/
          mkdir -p dist/modultool_portable
          rsync -a --delete ./ dist/modultool_portable/ \
            --exclude ".git" --exclude "dist" --exclude ".github"
          (cd dist && zip -r "../$ZIP" "modultool_portable")
          ls -lh "$ZIP"

      - name: Build .deb (template + launcher)
        shell: bash
        run: |
          set -euo pipefail
          PKG="modultool-video-werkstatt"
          VER="${{ steps.ver.outputs.version }}"
          ARCH="all"
          ROOTDIR="deb_build/${PKG}_${VER}_${ARCH}"
          rm -rf deb_build
          mkdir -p "$ROOTDIR/DEBIAN"
          mkdir -p "$ROOTDIR/usr/share/modultool_portable_template"
          mkdir -p "$ROOTDIR/usr/bin"
          mkdir -p "$ROOTDIR/usr/share/applications"
          mkdir -p "$ROOTDIR/usr/share/icons/hicolor/256x256/apps"

          # Template nach /usr/share
          rsync -a --delete ./ "$ROOTDIR/usr/share/modultool_portable_template/" \
            --exclude ".git" --exclude "deb_build" --exclude ".github"

          chmod +x "$ROOTDIR/usr/share/modultool_portable_template/tools/"*.sh || true

          # Icon
          if [ -f "$ROOTDIR/usr/share/modultool_portable_template/assets/default_assets/default_logo.png" ]; then
            cp "$ROOTDIR/usr/share/modultool_portable_template/assets/default_assets/default_logo.png" \
               "$ROOTDIR/usr/share/icons/hicolor/256x256/apps/modultool-video-werkstatt.png"
          fi

          # Launcher
          cat > "$ROOTDIR/usr/bin/modultool-video-werkstatt" <<'EOF'
          #!/usr/bin/env bash
          set -euo pipefail
          TEMPLATE_DIR="/usr/share/modultool_portable_template"
          USER_BASE="${XDG_DATA_HOME:-$HOME/.local/share}"
          TARGET_DIR="$USER_BASE/modultool_portable"

          if [ ! -d "$TARGET_DIR" ]; then
            mkdir -p "$USER_BASE"
            cp -a "$TEMPLATE_DIR" "$TARGET_DIR"
            chmod +x "$TARGET_DIR/tools/"*.sh || true
          fi

          exec "$TARGET_DIR/tools/start.sh"
          EOF
          chmod +x "$ROOTDIR/usr/bin/modultool-video-werkstatt"

          # Desktop entry
          cat > "$ROOTDIR/usr/share/applications/modultool-video-werkstatt.desktop" <<'EOF'
          [Desktop Entry]
          Type=Application
          Name=Modultool – Video-Werkstatt
          Comment=Standbild+Audio Videos bauen (Ton Safe), Automatik, Quarantäne, Werkbank
          Exec=modultool-video-werkstatt
          Icon=modultool-video-werkstatt
          Terminal=false
          Categories=AudioVideo;Utility;
          StartupNotify=true
          EOF

          # Control
          cat > "$ROOTDIR/DEBIAN/control" <<EOF
          Package: $PKG
          Version: $VER
          Section: video
          Priority: optional
          Architecture: $ARCH
          Maintainer: Modultool Builder <noreply@local>
          Depends: python3, python3-venv, ffmpeg
          Description: Modultool – Video-Werkstatt (Template + Launcher)
           Installiert eine Vorlage nach /usr/share und startet beim ersten Run eine Nutzerkopie.
          EOF

          # postinst
          cat > "$ROOTDIR/DEBIAN/postinst" <<'EOF'
          #!/usr/bin/env bash
          set -e
          command -v update-desktop-database >/dev/null 2>&1 && update-desktop-database -q || true
          command -v gtk-update-icon-cache >/dev/null 2>&1 && gtk-update-icon-cache -q -t -f /usr/share/icons/hicolor || true
          exit 0
          EOF
          chmod 755 "$ROOTDIR/DEBIAN/postinst"

          dpkg-deb --build "$ROOTDIR" "${PKG}_${VER}_${ARCH}.deb"
          ls -lh "${PKG}_${VER}_${ARCH}.deb"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-artifacts
          path: |
            modultool_portable_${{ steps.ver.outputs.version }}.zip
            modultool-video-werkstatt_${{ steps.ver.outputs.version }}_all.deb

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            modultool_portable_${{ steps.ver.outputs.version }}.zip
            modultool-video-werkstatt_${{ steps.ver.outputs.version }}_all.deb
